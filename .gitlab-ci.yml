workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never

stages: [test]

.maildns-base:
  stage: test
  tags: [windows]
  before_script:
    - $ProgressPreference = 'SilentlyContinue'
    - |
      if (-not $env:MAIL_DOMAINS) {
        Write-Host 'MAIL_DOMAINS not set - Check-MailDns.ps1 will load the default list.'
      }
  artifacts:
    when: always
    paths: [reports\maildns.json]

maildns:report:
  extends: .maildns-base
  script:
    - .\Check-MailDns.ps1 -ApiBase $env:API_BASE -Summary -OutputJson 'reports\maildns.json'
  allow_failure:
    exit_codes: [1]     # <- WARN (1) ist erlaubt, FAIL (2) bleibt rot

maildns:strict:
  extends: .maildns-base
  script:
    - .\Check-MailDns.ps1 -ApiBase $env:API_BASE -Strict -Summary -OutputJson 'reports\maildns.json'
  when: manual
